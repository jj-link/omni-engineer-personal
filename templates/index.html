<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Claude Engineer v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/marked@4.0.0/marked.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/model-selector.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script>
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            }
        });
    </script>
</head>
<body class="bg-gray-50">
    <div class="chat-container">
        <!-- Messages area -->
        <div class="messages-container" id="chat-messages">
            <!-- Initial message -->
            <div class="message-wrapper initial-message">
                <div class="flex items-start space-x-4">
                    <div class="w-8 h-8 rounded-full ai-avatar flex items-center justify-center text-white font-bold text-xs">
                        CE
                    </div>
                    <div class="flex-1">
                        <div class="prose prose-slate max-w-none">
                            <p>Welcome to Claude Engineer v3! I'm here to help with programming and development tasks. I can create custom tools on demand to help with any task you need - just ask!</p>
                            
                            <p>Available commands:</p>
                            <p>
                                <span class="command-code">refresh</span> - Reload available tools<br>
                                <span class="command-code">reset</span> - Clear conversation history<br>
                                <span class="command-code">quit</span> - Exit the conversation
                            </p>
                            
                            <p>How can I assist you today?</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Input area -->
        <div class="input-container">
            <div class="max-w-3xl mx-auto px-4">
                <!-- Model selector -->
                <div class="mb-4 flex items-center justify-between">
                    <div class="flex items-center space-x-3">
                        <label class="text-sm font-medium text-gray-700">Model:</label>
                        <div id="model-selector"></div>
                    </div>
                    
                    <!-- Image preview -->
                    <div id="image-preview" class="hidden">
                        <div class="relative inline-block">
                            <img id="preview-image" class="h-12 w-12 object-cover rounded" alt="Preview">
                            <button type="button" id="remove-image" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-sm">Ã—</button>
                        </div>
                    </div>
                </div>

                <!-- Chat form -->
                <form id="chat-form" class="relative">
                    <div class="flex items-start space-x-4">
                        <div class="flex-1">
                            <textarea
                                id="message-input"
                                name="message"
                                rows="1"
                                class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm resize-none"
                                placeholder="Type your message..."
                            ></textarea>
                        </div>
                        <div class="flex items-center space-x-2">
                            <button
                                type="submit"
                                class="inline-flex items-center rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                            >
                                Send
                            </button>
                            <button
                                id="upload-btn"
                                type="button"
                                class="inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2"
                            >
                                Upload
                            </button>
                            <input type="file" id="file-input" class="hidden" accept="image/*">
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="{{ url_for('static', filename='js/model-selector.js') }}"></script>
    <script src="{{ url_for('static', filename='js/chat.js') }}"></script>
    <script>
        // Initialize model selector
        const modelSelector = new ModelSelector(document.getElementById('model-selector'), {
            onModelSelect: async (model) => {
                try {
                    const response = await fetch('/switch_model', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ model: model.id })
                    });
                    
                    if (!response.ok) {
                        throw new Error('Failed to switch model');
                    }
                    
                    console.log('Switched to model:', model.id);
                } catch (error) {
                    console.error('Error switching model:', error);
                }
            }
        });

        // Fetch available models
        fetch('/models')
            .then(response => {
                if (!response.ok) {
                    throw new Error('Failed to fetch models');
                }
                return response.json();
            })
            .then(data => {
                console.log('Models data:', data);
                
                // Group models by provider
                const modelsByProvider = new Map();
                data.models.forEach(modelId => {
                    const [provider, name] = modelId.split('/');
                    if (!modelsByProvider.has(provider)) {
                        modelsByProvider.set(provider, []);
                    }
                    modelsByProvider.get(provider).push({
                        id: modelId,
                        description: data.descriptions[modelId] || 'No description available',
                        capabilities: data.capabilities[modelId] || []
                    });
                });

                // Update model selector
                modelSelector.providers = modelsByProvider;
                modelSelector.render();

                // Set current model if available
                if (data.current_model) {
                    const [provider] = data.current_model.split('/');
                    const models = modelsByProvider.get(provider);
                    const currentModel = models?.find(m => m.id === data.current_model);
                    if (currentModel) {
                        modelSelector.selectedModel = currentModel;
                        modelSelector.render();
                    }
                }
            })
            .catch(error => {
                console.error('Error fetching models:', error);
            });
    </script>
</body>
</html>